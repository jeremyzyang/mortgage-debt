---
title: "2006 Mortgage Debt"
author: "Jeremy Yang"
output: html_document



---

```{r warning=FALSE}
# read in data: you need to change the path and make sure certain packages are installed 
library(MASS)
library(car)
library(lme4)

demo <- read.csv('C:/Users/Jeremy/Desktop/Workspace/R/debt/county_demo.csv')
debt <- read.csv('C:/Users/Jeremy/Desktop/Workspace/R/debt/debt_06.csv')
house.price <- read.csv('C:/Users/Jeremy/Desktop/Workspace/R/debt/state_house_price.csv') # state level house price




```{r}
# select house price for 2006 and average over 4 quarters
house.price <- house.price[which(house.price$Year.Quarter=='2006Q1'|house.price$Year.Quarter=='2006Q2'|house.price$Year.Quarter=='2006Q3'|house.price$Year.Quarter=='2006Q4'), ]
hp <- house.price[which(house.price$State!='US'),]

# remove the '$' and ',' symbols
hp$Average.Price <- gsub('\\$|,','',hp$Average.Price) 
hp$Average.Price <- as.numeric(hp$Average.Price) 

 # calculate average
state <- unique(debt$state)
average <- tapply(hp$Average.Price,hp$State,mean)
average <- average[-c(1,45)]
average <- data.frame(state,average)
colnames(average) <- c('state','house_price_average')
```
```{r}
# merge three dataset
data <- merge(debt,demo,'FIPS')
data['State_Name'] <- NULL; data['County_Name'] <- NULL
data2 <- merge(data,average,'state')
data2[,22:28] <- data[,22:28]
data <- data2
colnames(data)[32] <- 'State_house_price_average'

# here are all the variables in the merged dataset
colnames(data) 
```
```{r}
# then we standardize the explanatory variables to normalize the scale, so it'd be easier to compare the magnitude of coefficients 
data.std <- scale(data[,c(10:28,32)])
data2 <- data
data2[,c(10:28,32)]<-data.std
data.std <- data2
```


```{r}
# OLS on mortgage debt (the code can be easily extended to auto and credit)
ols.mortgage <- lm(Mortgage ~ Female_life_Growth + Male_life_Growth + Per_young + Per_old +
                     Per_white + Per_black + Per_hispanic + Per_single_mother + Per_NO_HighSchool + Per_college +
                     Rate_median_income + Percent_divorced + Per_Evangelical_adherent +
                     Per_Evangelical_congregations + Per_Obama + Per_Rural + Rate_Teen_Birth +
                     Rate_Violent_Crime, data.std)
summary(ols.mortgage)

# these predictors are strongly correlated
with(data,scatterplot(Per_Evangelical_adherent,Per_Evangelical_congregations)) 
with(data,scatterplot(Per_single_mother,Percent_divorced))
with(data,scatterplot(Per_white,Per_black))

# test for multicollinearity: Per_single_mother, Per_Evangelical_adherent and Per_white/black are problematic 
vif(ols.mortgage) 

# drop them and run the model again
ols.mortgage <- lm(Mortgage ~ Female_life_Growth + Male_life_Growth + Per_young + Per_old +
                     Per_black + Per_NO_HighSchool + Per_college +
                     Rate_median_income + Percent_divorced + Per_Evangelical_congregations + Per_Obama + Per_Rural + Rate_Teen_Birth +
                     Rate_Violent_Crime, data.std) 
summary(ols.mortgage)

# now it looks better
vif(ols.mortgage) 

# then we try the log transformation of dependent variable
ols.log.mortgage <- lm(log(Mortgage) ~ Female_life_Growth + Male_life_Growth + Per_young + Per_old +
                     Per_black + Per_NO_HighSchool + Per_college + Rate_median_income + Percent_divorced +
                     Per_Evangelical_congregations + Per_Obama + Per_Rural + Rate_Teen_Birth +
                     Rate_Violent_Crime, data.std)
summary(ols.log.mortgage)
```

```{r}
# We might suspect state level varaible (policy,ect.) would have systematic influence on debt, we can try to fit a hierarchical model to include state level predictor (only average house price for now, but we can also add in group mean of county-level predictors and more)

# we add in random intercept
lme.mortgage <- lmer(Mortgage ~ Female_life_Growth + Male_life_Growth + Per_young + Per_old +
                       Per_black + Per_NO_HighSchool + Per_college + Rate_median_income + Percent_divorced + 
                       Per_Evangelical_congregations + Per_Obama + Per_Rural + Rate_Teen_Birth + Rate_Violent_Crime +
                       State_house_price_average + (1|state), data.std) 
summary(lme.mortgage)
# we can see that state level house price is a significant predictor, counties within in high price state has higher value on intercept
```


